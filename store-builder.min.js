(function(){var t,e,r,n,i,o,s,u,h,c,l,a,g,p=[].slice,d={}.hasOwnProperty;n="store-builder",t="anonymus function",e="anonymus store-builder",o=2e4,r="timeout error",g=require("types.js"),s=require("control-timeout"),h=require("deep-freeze"),c=require("define-prop"),u=require("uuid"),a=require("merge-plus"),l=require("func-name").nameAnonymus(t),i=function(){function i(t){t=g.forceObject(t),this.id=g.forceString(t.id,e),this.delay=this.validDelay(t.timeoutDelay),this.timeout=new s(this.delay),this.showDebug=!1,this.contextCall=g.forceBoolean(t.contextCall!==!1),this.errors=[],this.init()}return i.delay=o,i.log=function(){var t;return t=1<=arguments.length?p.call(arguments,0):[],g.forceFunction("undefined"!=typeof console&&null!==console?console.log.apply(console,[n].concat(p.call(t))):void 0)},i.create=function(t){var e,r,i;t=g.forceObject(t),e=g.forceFunction(t.action);for(r in t)d.call(t,r)&&(i=t[r],e[r]=i);return e.type=n,e},i.prototype.init=function(){return this.store={},this.queue=[],this.middleware=[],this.current=null,this.isRunning=!1,this.count=0,this.showStore=!1,this.hasTimeout=!1,this.error="",this},i.prototype.callAction=function(t){return this.contextCall?g.forceFunction(t).call(this,this.store,this):g.forceFunction(t)(this.store,this)},i.prototype.validDelay=function(t){var e,r,n,s;for(s=[t,this.delay,i.delay],r=0,n=s.length;n>r;r++)if(e=s[r],e=g.forceNumber(e,0))return Math.abs(e);return o},i.prototype.runMiddleware=function(){var t,e,r,n;for(n=this.middleware,e=0,r=n.length;r>e;e++)t=n[e],this.callAction(t);return this},i.prototype.finalizeCurrent=function(){return this.current?(this.timeout.remove(this.current.id),this.showLog(),this.error=""):void 0},i.prototype.next=function(t){return this.isRunning?t?this.halt(t):(this.finalizeCurrent(),this.queue.length&&(this.count++,this.current=this.queue.shift(),this.runMiddleware(),this.timeout.run(this.current.id,this.store,this),this.callAction(this.current.action)),this):this},i.prototype.start=function(){return this.isRunning?this:(this.isRunning=!0,this.errors=[],this.showDebug&&i.log('- logging "'+this.id+'" instance:\n'),this.next())},i.prototype.handleError=function(t){return t?this.halt(t):void 0},i.prototype.halt=function(){var t,e,r,n;return t=1<=arguments.length?p.call(arguments,0):[],this.current&&this.errors.push(this.error=t.join(", ")),e=g.forceString(null!=(r=this.current)?r.name:void 0,"unknown"),(null!=(n=this.current)?n.proceedOnError:void 0)?(i.log("- an error occured in: "+e+", with error: "+this.error),i.log("proceed on error was set, continuing sequence now.."),this.next()):this.isRunning?(i.log('- halted by function:"'+e+'", with error:',this.error),this.timeout.removeAll(),this.isRunning=!1,this.callAction(this.errorHandler),i.log("- terminating sequence, initiating reset"),this.init()):void 0},i.prototype.use=function(){var t,e,r,n;for(e=1<=arguments.length?p.call(arguments,0):[],r=0,n=e.length;n>r;r++)t=e[r],g.isFunction(t)?this.middleware.push(t):i.log("- cannot use non-function argument!");return this},i.prototype.onError=function(t){return this.errorHandler=t,this},i.prototype._addTimeout=function(t){return this.timeout.add({id:t.id,delay:t.delay,action:function(e){return function(){return i.log("- a timeout has been triggered for function:",t.name),e.hasTimeout=!0,e.callAction(t.timeoutAction),t.proceedOnError?i.log('- proceed on error was set for: "'+t.name+'", continuing sequence now..'):e.halt(r)}}(this)})},i.prototype.add=function(){var t,e,r,o,s,h;for(o=1<=arguments.length?p.call(arguments,0):[],e=[],s=0,h=o.length;h>s;s++)r=o[s],g.notFunction(r)?i.log(n+"- invalid or non-function encountered in arguments!"):(e.push(t={id:u.v4(),name:r.id||l(r),action:r,timeoutAction:r.timeoutAction,delay:this.validDelay(r.timeoutDelay),proceedOnError:r.proceedOnError}),this._addTimeout(t));return e.length&&(this.queue=e.concat(this.queue)),this},i.prototype.remove=function(){var e,r,n,o,s,u,h,c,a,d,f,m,y;for(n=1<=arguments.length?p.call(arguments,0):[],o=0,c=n.length;c>o;o++)if(r=n[o],g.isString(r))for(m=this.queue,s=u=0,a=m.length;a>u;s=++u)e=m[s],f=l(null!=e?e.action:void 0),s>-1&&f!==t&&(this.queue.splice(s,1),i.log('- function with name: "'+f+'" was removed from the sequence!'));else if(g.isFunction(r))for(y=this.queue,s=h=0,d=y.length;d>h;s=++h)e=y[s],(null!=e?e.action:void 0)===r&&s>-1&&(this.queue.splice(s,1),i.log('- function with name: "'+l(r)+'" was removed from the sequence!'));return this},i.prototype._assign=function(t,e,r,n){var o,s,u;if(g.notObject(e)&&(e=g.forceObject(t),t=this.store),g.notObject(t))return i.log("- ERROR, invalid/missing target or source, cannot modify store!");for(s in e)u=e[s],r&&t.hasOwnProperty(s)?i.log("- WARNING, cannot merge: "+u+' into target object, key: "'+s+'" already exists!'):(o=Object.getOwnPropertyDescriptor(t,s),!o||o.writable?n?c(t,s,u,"enumerable"):t[s]=u:i.log('- WARNING, cannot write to object, key: "'+s+'" is immutable!'));return this},i.prototype.assign=function(t,e){return this._assign(t,e)},i.prototype.assignFrozen=function(t,e){return this._assign(t,e,!1,!0)},i.prototype.merge=function(t,e){return this._assign(t,e,!0)},i.prototype.mergeFrozen=function(t,e){return this._assign(t,e,!0,!0)},i.prototype.debug=function(){return this.showDebug=!0,this},i.prototype.showLog=function(){var t,e,r,n,o,s,u,h,c;if(this.showDebug){for(r=[],h=this.queue,n=0,o=h.length;o>n;n++)t=h[n],r.push(l(t.action));this.hasTimeout||(s=this.current.name,e="",u="",this.error&&(e=" RETURNED WITH ERROR: "+this.error),i.log("FUNCTION "+this.count+'		: "'+this.current.name+'"'+e),i.log("STORE				: ",this.store,u)),c=1===this.queue.length?"":"s",i.log(this.queue.length+" function"+c+" left in queue:",r),this.error&&this.current.proceedOnError&&this.queue.length&&i.log('- proceed was set for function: "'+this.current.name+'", continuing sequence now..'),i.log("----------------------------------"),this.queue.length||(this.errors.length||this.hasTimeout?(c=this.errors.length<2?"":"s",i.log("-> done with "+this.errors.length+" error"+c+"!")):i.log("-> done, without errors."))}return this},i}(),i.prototype.run=i.prototype.start,i.prototype.stop=i.prototype.halt,module.exports=i}).call(this);