(function(){var t,e,n,r,i,o,s,u,h,l,c,a,g=[].slice;t="anonymus function",a=require("types.js"),i=require("control-timeout"),s=require("deep-freeze"),u=require("define-prop"),o=require("uuid"),l=require("merge-plus"),h=require("func-name").nameAnonymus(t),c="store-builder",r=2e4,e="anonymus store-builder",n=function(){function n(t){t=a.forceObject(t),this.id=a.forceString(t.id,e),this.delay=this.validDelay(t.timeoutDelay),this.timeout=new i(this.delay),this.showDebug=!1,this.contextCall=a.forceBoolean(t.contextCall!==!1),this.errors=[],this.init()}return n.delay=r,n.log=function(){var t;return t=1<=arguments.length?g.call(arguments,0):[],a.forceFunction("undefined"!=typeof console&&null!==console?console.log.apply(console,[c].concat(g.call(t))):void 0)},n.create=function(t){var e,n,r;t=a.forceObject(t),e=a.forceFunction(t.action);for(n in t)r=t[n],t.hasOwnProperty(n)&&(e[n]=r);return e.type=c,e},n.prototype.callAction=function(t){return this.contextCall?a.forceFunction(t).call(this,this.store,this):a.forceFunction(t)(this.store,this)},n.prototype.validDelay=function(t){var e,i,o,s;for(s=[t,this.delay,n.delay],i=0,o=s.length;o>i;i++)if(e=s[i],e=a.forceNumber(e,0))return Math.abs(e);return r},n.prototype.runMiddleware=function(){var t,e,n,r;for(r=this.middleware,e=0,n=r.length;n>e;e++)t=r[e],this.callAction(t);return this},n.prototype.finalizeCurrent=function(){return this.current?(this.timeout.remove(this.current.id),this.showLog(),this.error=""):void 0},n.prototype.next=function(){return this.finalizeCurrent(),this.queue.length&&(this.count++,this.current=this.queue.shift(),this.runMiddleware(),this.timeout.run(this.current.id,this.store,this),this.callAction(this.current.action)),this},n.prototype.start=function(){return this.isRunning?this:(this.errors=[],this.showDebug&&n.log('- logging "'+this.id+'" instance:\n'),this.next())},n.prototype.init=function(){return this.store={},this.queue=[],this.middleware=[],this.current=null,this.isRunning=!1,this.count=0,this.showStore=!1,this.hasTimeout=!1,this.error="",this},n.prototype.halt=function(){var t,e,r;return t=1<=arguments.length?g.call(arguments,0):[],(null!=(e=this.current)?e.proceed:void 0)||this.timeout.removeAll(),this.current&&this.errors.push(this.error=t.join(", ")),this.callAction(this.errorHandler),n.log('- halted by function:"',this.current.name+'", with error:',this.error),(null!=(r=this.current)?r.proceed:void 0)?this.next():(n.log("- terminating sequence, initiating reset"),this.init())},n.prototype.handleError=function(t){return t?this.halt(t):this.next(),a.forceString(t)},n.prototype.handleWarning=function(t){return t?(n.log(this.current.name+"- warning! ",t),this.next()):void 0},n.prototype.use=function(){var t,e,r,i;for(e=1<=arguments.length?g.call(arguments,0):[],r=0,i=e.length;i>r;r++)t=e[r],a.isFunction(t)?this.middleware.push(t):n.log("- cannot use non-function argument!");return this},n.prototype.onError=function(t){return this.errorHandler=t,this},n.prototype._addTimeout=function(t){return this.timeout.add({id:t.id,delay:t.delay,action:function(e){return function(){return n.log("- a timeout has been triggered for function:",t.name),e.hasTimeout=!0,e.callAction(t.timeoutAction),t.proceed?n.log('- proceed was set for function: "'+t.name+'", continuing sequence now..'):e.halt()}}(this)})},n.prototype.add=function(){var t,e,r,i,s,u;for(i=1<=arguments.length?g.call(arguments,0):[],e=[],s=0,u=i.length;u>s;s++)r=i[s],a.notFunction(r)?n.log(c+"- invalid or non-function encountered in arguments!"):(e.push(t={id:o.v4(),name:h(r),action:r,timeoutAction:r.timeoutAction,delay:this.validDelay(r.timeoutDelay),proceed:r.errorProceed,parallel:a.forceBoolean(r.parallel)}),this._addTimeout(t));return e.length&&(this.queue=e.concat(this.queue)),this},n.prototype.remove=function(){var e,r,i,o,s,u,l,c,p,f,d,m,y;for(i=1<=arguments.length?g.call(arguments,0):[],o=0,c=i.length;c>o;o++)if(r=i[o],a.isString(r))for(m=this.queue,s=u=0,p=m.length;p>u;s=++u)e=m[s],d=h(null!=e?e.action:void 0),s>-1&&d!==t&&(this.queue.splice(s,1),n.log('- function with name: "'+d+'" was removed from the sequence!'));else if(a.isFunction(r))for(y=this.queue,s=l=0,f=y.length;f>l;s=++l)e=y[s],(null!=e?e.action:void 0)===r&&s>-1&&(this.queue.splice(s,1),n.log('- function with name: "'+h(r)+'" was removed from the sequence!'));return this},n.prototype._assign=function(t,e,r,i){var o,s,h;if(a.notObject(e)&&(e=a.forceObject(t),t=this.store),a.notObject(t))return n.log("- ERROR, invalid/missing target or source, cannot modify store!");for(s in e)h=e[s],r&&t.hasOwnProperty(s)?n.log("- WARNING, cannot merge: "+h+' into target object, key: "'+s+'" already exists!'):(o=Object.getOwnPropertyDescriptor(t,s),!o||o.writable?i?u(t,s,h,"enumerable"):t[s]=h:n.log('- WARNING, cannot write to object, key: "'+s+'" is immutable!'));return this},n.prototype.assign=function(t,e){return this._assign(t,e)},n.prototype.assignFrozen=function(t,e){return this._assign(t,e,!1,!0)},n.prototype.merge=function(t,e){return this._assign(t,e,!0)},n.prototype.mergeFrozen=function(t,e){return this._assign(t,e,!0,!0)},n.prototype.debug=function(){return this.showDebug=!0,this},n.prototype.showLog=function(){var t,e,r,i,o,s,u,l,c;if(this.showDebug){for(r=[],l=this.queue,i=0,o=l.length;o>i;i++)t=l[i],r.push(h(t.action));this.hasTimeout||(s=this.current.name,e="",u="",this.error&&(e=" RETURNED WITH ERROR: "+this.error),this.current.parallel&&(u="	( parallel function, store might not be updated yet! )"),n.log("FUNCTION "+this.count+'		: "'+this.current.name+'"'+e),n.log("STORE				: ",this.store,u)),c=1===this.queue.length?"":"s",n.log(this.queue.length+" function"+c+" left in queue:",r),this.error&&this.current.proceed&&this.queue.length&&n.log('- proceed was set for function: "'+this.current.name+'", continuing sequence now..'),n.log("----------------------------------"),this.queue.length||(this.errors.length||this.hasTimeout?(c=this.errors.length<2?"":"s",n.log("-> done with "+this.errors.length+" error"+c+"!")):n.log("-> done, without errors."))}return this},n}(),n.prototype.run=n.prototype.start,n.prototype.stop=n.prototype.halt,module.exports=n}).call(this);